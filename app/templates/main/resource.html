{% extends 'layouts/base.html' %}
{% import 'macros/form_macros.html' as f %}

{% block content %}
    <div class="ui stackable centered grid container">
        <div class="twelve wide column">
            {% if from_saved %}
            <a class="ui basic compact button" href="{{ url_for('main.review_saved') }}">
                <i class="caret left icon"></i>
                Back to saved resources
            </a>
            {% else %}
            <a class="ui basic compact button" href="{{ url_for('main.index') }}">
                <i class="caret left icon"></i>
                Back to database
            </a>
            {% endif %}
              <div style="height:15px;"></div>
              {% if user_type == 'admin'%}
              <div class="ui buttons">
                  <a class="ui button" href="{{ url_for('admin.delete_entry', id=resource.id) }}">
                      <i class="delete icon"></i>
                      Delete
                  </a>
                  <a class="ui button" href="{{ url_for('admin.contribution_' + resource.doc_type, id=resource.id) }}">
                      <i class="edit icon"></i>
                      Edit
                  </a>
                  <a class="ui button" href="javascript:togglePublish('{{ resource.id }}')">
                      <i class="share square icon"></i>
                      {% if resource.document_status == 'published'%}
                        <span id="publish">Unpublish</span>
                      {% else %}
                        <span id="publish">Publish</span>
                      {% endif %}
                  </a>
              </div>
              {% endif %}
            <br>
            <br>
            <div style="width:100%">
              <h2 class="ui header" style="overflow-wrap: break-word; float:left; margin-bottom:15px;">
                  {{ resource.title }}
                  <div class="sub header">
                    {% if (resource.author_last_name and resource.author_first_name) or resource.name or resource.govt_body %}
                      {% if resource.author_last_name and resource.author_first_name %}
                          {% set first_names=resource.author_first_name.split(',') %}
                          {% set last_names=resource.author_last_name.split(',') %}
                          By
                            {% for x in range(first_names | length) %}
                              {% if (x == first_names | length - 1) %}
                              {{ first_names[x] + ' ' + last_names[x] }}
                              {% else %}
                              {{ first_names[x] + ' ' + last_names[x] + ','}}
                              {% endif %}
                            {% endfor %}
                        {% elif resource.name %}
                          By {{ resource.name }}
                        {% elif resource.govt_body %}
                          Enacted by {{ resource.govt_body }}
                        {% endif %}
                      {% endif %}
                    </div>
                    <div class="ui basic label" style="margin:2px;">
                     {% if resource.type == 'other' %}
                       {{ resource.other_type }}
                     {% else %}
                       {{ resource.doc_type.split('_')|join(' ') }}
                     {% endif %}
                    </div>
              </h2>
            </div>
            <table class="ui searchable sortable unstackable selectable celled table" style="overflow-x: scroll;">
              <thead>
                  <tr>
                      <th class="three wide" style="padding:0; border-bottom:0;"></th>
                      <th class="nine wide" style="padding:0; border-bottom:0;"></th>
                  </tr>
              </thead>
               <tbody>
                   {% if resource.tags | length > 0 %}
                   <tr>
                     <td>Tags</td>
                     <td>
                      {% for tag in resource.tags %}
                       <div class="ui basic label" style="margin: 2px">
                         {{ tag.tag.tag }}
                       </div>
                       {% endfor %}
                     </td>
                   </tr>
                  {% endif %}
                    {% if resource.editor_last_name and resource.editor_first_name %}
                        <td>Editor</td>
                        {% set first_names=resource.editor_first_name.split(',') %}
                        {% set last_names=resource.editor_last_name.split(',') %}
                        <td>
                          {% for x in range(first_names | length) %}
                            {% if (x == first_names | length - 1) %}
                            {{ first_names[x] + ' ' + last_names[x] }}
                            {% else %}
                            {{ first_names[x] + ' ' + last_names[x] + ','}}
                            {% endif %}
                          {% endfor %}
                        </td>
                    {% endif %}
                  {% if resource.day and resource.month and resource.year %}
                     <td>Date</td>
                     <td>{{ resource.month ~ ' ' ~ resource.day ~ ', ' ~ resource.year }}</td>
                  {% elif resource.month and resource.year %}
                     <td>Date</td>
                     <td>{{ resource.month ~ ' ' ~ resource.year }}</td>
                  {% elif resource.year %}
                     <td>Year</td>
                     <td>{{ resource.year }}</td>
                  {% endif %}
                  {% if resource.other_type %}
                   <tr>
                     <td>Type (if other)</td>
                     <td>{{ resource.other_type }}</td>
                   </tr>
                   <tr>
                   {% endif %}
                   {% if resource.citation %}
                   <tr>
                     <td>Citation</td>
                     <td>{{ resource.citation }}</td>
                   </tr>
                   {% endif %}
                   {% if resource.volume %}
                   <tr>
                     <td>Volume</td>
                     <td>{{ resource.volume }}</td>
                   </tr>
                   {% endif %}
                   {% if resource.edition %}
                   <tr>
                     <td>Edition</td>
                     <td>{{ resource.edition }}</td>
                   </tr>
                   {% endif %}
                   {% if resource.series %}
                   <tr>
                     <td>Series</td>
                     <td>{{ resource.series }}</td>
                   </tr>
                   {% endif %}
                   {% if resource.name %}
                   <tr>
                     <td>Name</td>
                     <td>{{ resource.name }}</td>
                   </tr>
                   {% endif %}
                   {% if resource.region and resource.country %}
                   <tr>
                     <td>Location</td>
                     <td>{{ resource.region  ~ ', ' ~ resource.country }}</td>
                   </tr>
                   {% elif resource.region %}
                   <tr>
                     <td>Region</td>
                     <td>{{ resource.region }}</td>
                   </tr>
                   {% endif %}
                   {% if resource.section %}
                   <tr>
                     <td>Section</td>
                     <td>{{ resource.section }}</td>
                   </tr>
                   {% endif %}
                   {% if resource.description %}
                    <tr>
                      <td>Description</td>
                      <td>{{ resource.description }}</td>
                    </tr>
                   {% endif %}
               </tbody>
           </table>
           <div class="ui buttons">
           {% if resource.link %}
           <a class="ui button" href="{{ resource.link }}" target="_blank">
               <i class="linkify icon"></i>
               <span id="link">Access Resource</span>
           </a>
           {% endif %}
           {% if resource.file %}
           <a class="ui button" href="{{ resource.file }}">
               <i class="file icon"></i>
               <span id="file">Access Resource File</span>
           </a>
           {% endif %}
           {% if user_id %}
           <a class="ui button" href="javascript:toggleSave('{{ resource.id }}')">
               <i class="save icon"></i>
               {% if saved %}
                 <span id="save">Unsave</span>
               {% else %}
                 <span id="save">Save</span>
               {% endif %}
           </a>
           {% endif %}
           </div>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            var save_btn=$('#save-btn');
                save_btn.text('Unsave resource');
                save_btn.addClass('active');
        });
        var csrf_token="{{ csrf_token() }}";
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrf_token);
                }
            }
        });
        function togglePublish(id) {
            $.post('/admin/toggle_publish', {
                id: id
            }).done(function(response) {
              $("#publish").text(response.status);
            }).fail(function() {
                // TODO?
            });
        }
        function toggleSave(id) {
            $.post('/toggleSave', {
                id: id
            }).done(function(response) {
                $("#save").text(response.status);
            }).fail(function() {
                // TODO?
            });
        }
    </script>
{% endblock %}
