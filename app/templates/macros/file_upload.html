
{% macro file_upload(fieldname) %}
<script>
  $('body').on('change', '#file-{{ fieldname }}', function() {
  var file=$(this)[0].files[0];
  {{fieldname}}_getSignedRequest(file)
})

function {{fieldname}}_getSignedRequest(file){
  var xhr=new XMLHttpRequest();
  if (file.name && file.name.length > 0) {
    xhr.open('GET', `/sign-s3?file-name=${file.name}&file-type=${file.type}`);
    xhr.onreadystatechange=function() {
    if (xhr.readyState === 4) {
      console.log(xhr.responseText);
      if (xhr.status === 200){
        var response=JSON.parse(xhr.responseText);
        {{fieldname}}_uploadFile(file, response.data, response.url, response.url_upload)
      } else {
        alert('Could not get presigned URL.'); //INTERNAL SERVER ERROR HERE
      }
    }
  }
};
  xhr.send();
}

function {{fieldname}}_uploadFile(file, s3Data, url, urlUpload, fieldName) {
  // basic validation
  var fileType=url.substring(url.lastIndexOf('.') + 1);
  var xhr=new XMLHttpRequest();
  xhr.open('POST', urlUpload);
  xhr.setRequestHeader('x-amz-acl', 'public-read');
  var postData=new FormData();
  postData.append('key', s3Data.fields.key);
  postData.append('file', file);
  xhr.onreadystatechange=function()  {
    if (xhr.readyState === 4) {
      if (xhr.status === 200 || xhr.status === 204) {
        {{fieldname}}_handleFunc(url, file);
      } else {
        alert('Could not upload file.');
      }
    }
  };
  xhr.send(postData);
}

function {{fieldname}}_handleFunc(url, file) {
  console.log(url);
  var curr=$("#{{ fieldname }}").val()
  $("div > input#{{ fieldname }}").val(curr + ( curr ? ',': '' ) + url);
  $("#{{ fieldname }}_list").append(
    '<div class="badge badge-light"><i class="file icon"></i><a href="' + url + '">' + url + '</a><span id="{{fieldname}}-delete"class="delete badge badge-danger" data-url="' + url + '"><br/>Delete Document</span></span>')
};

$('body').on('click', '#{{fieldname}}-delete', function() {
  var url=$(this).data('url');

  var arr=$("div > input#{{ fieldname }}").val().split(',');
  var idx=arr.indexOf(url);
  if (idx > -1) {
    arr.splice(idx, 1)
  }
  $("div > input#{{ fieldname }}").val(arr.join(','))
  $(this).parent().remove();
  $(this).remove();
})
</script>


{% endmacro %}
